###############################################
# Optimized for Angular SSR Production
###############################################

# -----------------------------
# GLOBAL SETTINGS
# -----------------------------
user nginx;
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    tcp_nopush    on;
    tcp_nodelay   on;

    gzip on;
    gzip_static on;
    gzip_comp_level 5;
    gzip_types text/plain application/xml application/json text/css text/javascript application/javascript;

    # -----------------------------
    # SERVER BLOCK
    # -----------------------------
    server {
        listen 80;
        listen [::]:80;

        server_name _;

        # -----------------------------
        # SERVE STATIC FILES FROM BROWSER BUILD
        # -----------------------------
        location /browser/ {
            alias /usr/share/nginx/html/browser/;
            expires 30d;
            add_header Cache-Control "public, max-age=2592000, immutable";
        }

        # -----------------------------
        # ALL API & SSR REQUESTS â†’ Node SSR
        # -----------------------------
        location / {
            proxy_pass http://ssr:4000;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }
    }
}
